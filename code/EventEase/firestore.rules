rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is the owner of a document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to check if user has admin role
    // Note: This function reads the user's own document, which is allowed via isOwner() below
    function isAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles != null &&
             'admin' in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles;
    }
    
    // Users collection – users can read/write only their own document
    // Admins can read all user documents (required for admin profile management)
    // Admins can delete any user document
    match /users/{userId} {
      // Users can always read their own document (this allows isAdmin() to work)
      allow read: if isOwner(userId);
      
      // Admins can read any user document (including their own, but explicitly allowed for all)
      allow read: if isAdmin();
      
      // Users can write their own document
      allow write: if isOwner(userId);
      
      // Admins can delete any user document
      allow delete: if isAdmin();
    }
    
    // Events collection – authenticated users can read/write events
    // Admins have full access to events for management
    match /events/{eventId} {
      // Anyone authenticated can read events
      allow read: if isAuthenticated();
      
      // Anyone authenticated can write events (or restrict to organizers if needed)
      allow write: if isAuthenticated();
      
      // Admins can update/delete any event
      allow update, delete: if isAdmin();
      
      // Event subcollections used for participant states
      match /WaitlistedEntrants/{docId} {
        // Authenticated users can read/write
        allow read, write: if isAuthenticated();
        // Admins can always read/delete (for profile deletion cleanup)
        allow read, delete: if isAdmin();
        // Users can delete their own entries
        allow delete: if isAuthenticated() && docId == request.auth.uid;
      }
      
      match /SelectedEntrants/{docId} {
        // Authenticated users can read/write
        allow read, write: if isAuthenticated();
        // Admins can always read/delete (for profile deletion cleanup)
        allow read, delete: if isAdmin();
        // Users can delete their own entries
        allow delete: if isAuthenticated() && docId == request.auth.uid;
      }
      
      match /NonSelectedEntrants/{docId} {
        // Authenticated users can read/write
        allow read, write: if isAuthenticated();
        // Admins can always read/delete (for profile deletion cleanup)
        allow read, delete: if isAdmin();
        // Users can delete their own entries
        allow delete: if isAuthenticated() && docId == request.auth.uid;
      }
      
      match /CancelledEntrants/{docId} {
        // Authenticated users can read/write
        allow read, write: if isAuthenticated();
        // Admins can always read/delete (for profile deletion cleanup)
        allow read, delete: if isAdmin();
        // Users can delete their own entries
        allow delete: if isAuthenticated() && docId == request.auth.uid;
      }
      
      // AdmittedEntrants subcollection
      match /AdmittedEntrants/{userId} {
        // Authenticated users can read/write
        allow read, write: if isAuthenticated();
        // Admins can always read/delete (for profile deletion cleanup)
        allow read, delete: if isAdmin();
        // Users can delete their own entries
        allow delete: if isAuthenticated() && userId == request.auth.uid;
      }
    }
    
    // Legacy waitlists collection (if you still use them)
    match /waitlists/{waitlistId} {
      // Anyone authenticated can read/write
      allow read, write: if isAuthenticated();
      // Admins have full access
      allow read, write: if isAdmin();
    }
    
    // Legacy admitted collection (if you still use them)
    match /admitted/{admittedId} {
      // Anyone authenticated can read/write/create
      allow read, write, create, update: if isAuthenticated();
      // Admins have full access
      allow read, write, create, update: if isAdmin();
    }
    
    // Invitations collection rules
    match /invitations/{invitationId} {
      // Allow users to read their own invitations (by uid field)
      // OR admins can read all invitations
      allow read: if isAuthenticated() && (
        (resource.data.uid != null && resource.data.uid == request.auth.uid) ||
        (resource.data.entrantId != null && resource.data.entrantId == request.auth.uid) ||
        (resource.data.organizerId != null && resource.data.organizerId == request.auth.uid) ||
        isAdmin()
      );
      
      // Allow organizers to create invitations (you may want to add organizer check)
      allow create: if isAuthenticated();
      
      // Allow users to update their own invitations (for accept/decline)
      // OR admins can update any invitation
      allow update: if isAuthenticated() && (
        ((resource.data.uid != null && resource.data.uid == request.auth.uid) ||
         (resource.data.entrantId != null && resource.data.entrantId == request.auth.uid)) &&
        request.resource.data.keys().hasAll(['status']) &&
        (request.resource.data.status == 'ACCEPTED' || 
         request.resource.data.status == 'DECLINED')
      ) || isAdmin();
      
      // Allow organizers to update invitations
      // OR admins can update any invitation
      allow update: if isAuthenticated() && (
        resource.data.organizerId != null && resource.data.organizerId == request.auth.uid
      ) || isAdmin();
      
      // Admins can delete any invitation
      allow delete: if isAdmin();
      // Users can delete their own invitations
      allow delete: if isAuthenticated() && (
        (resource.data.uid != null && resource.data.uid == request.auth.uid) ||
        (resource.data.entrantId != null && resource.data.entrantId == request.auth.uid) ||
        (resource.data.organizerId != null && resource.data.organizerId == request.auth.uid)
      );
    }
    
    // Images collection (for admin image management)
    match /images/{imageId} {
      // Anyone authenticated can read images
      allow read: if isAuthenticated();
      
      // Anyone authenticated can create images
      allow create: if isAuthenticated();
      
      // Image creator or admin can update/delete
      allow update, delete: if isAuthenticated() && (
        resource.data.uploadedBy == request.auth.uid ||
        isAdmin()
      );
    }
    
    // Collection group query for AdmittedEntrants (allows users to find their own entries across events)
    match /{path=**}/AdmittedEntrants/{userId} {
      // Users can read their own entries OR admins can read all
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
    }
    
    // Default: deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}